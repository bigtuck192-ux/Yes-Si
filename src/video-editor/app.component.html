<!-- Main Application Container -->
<main class="bg-black text-white font-mono min-h-screen flex items-center justify-center p-2 sm:p-4 relative overflow-hidden">
  <app-matrix-background></app-matrix-background>

  <div class="w-full max-w-7xl rounded-2xl border bg-slate-900/40 backdrop-blur-xl shadow-2xl z-10 flex flex-col transition-all duration-500 overflow-hidden" 
       [class]="'border-' + currentTheme().primary + '-400/30 shadow-' + currentTheme().primary + '-500/10'">
    
    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-center p-4 border-b border-white/10 bg-black/20">
      <h1 class="text-2xl font-bold tracking-tight mb-2 sm:mb-0" [class]="mainTextColorClass()">
        <i class="fa-solid fa-gem mr-2"></i>[ AURA STUDIO ]
      </h1>
      
      <div class="flex flex-wrap items-center justify-center gap-2">
         <!-- Navigation Pills -->
         <div class="flex bg-black/40 rounded-full p-1 border border-white/5 backdrop-blur-md">
            <button (click)="setMode('player')" [class]="mainViewMode() === 'player' ? 'bg-' + currentTheme().primary + '-500 text-black shadow-lg' : 'hover:bg-white/10 text-gray-400'" class="px-3 py-1.5 rounded-full text-xs transition-all">PLAYER</button>
            <button (click)="setMode('dj')" [class]="mainViewMode() === 'dj' ? 'bg-' + currentTheme().primary + '-500 text-black shadow-lg' : 'hover:bg-white/10 text-gray-400'" class="px-3 py-1.5 rounded-full text-xs transition-all">DJ</button>
            <button (click)="setMode('live')" [class]="mainViewMode() === 'live' ? 'bg-red-500 text-white shadow-lg shadow-red-500/30' : 'hover:bg-white/10 text-gray-400'" class="px-3 py-1.5 rounded-full text-xs transition-all flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-400 animate-pulse"></span>LIVE</button>
            <button (click)="setMode('piano-roll')" [class]="mainViewMode() === 'piano-roll' ? 'bg-' + currentTheme().primary + '-500 text-black shadow-lg' : 'hover:bg-white/10 text-gray-400'" class="px-3 py-1.5 rounded-full text-xs transition-all">KEYS</button>
            <button (click)="setMode('image-editor')" [class]="mainViewMode() === 'image-editor' ? 'bg-' + currentTheme().primary + '-500 text-black shadow-lg' : 'hover:bg-white/10 text-gray-400'" class="px-3 py-1.5 rounded-full text-xs transition-all">IMG</button>
            <button (click)="setMode('video-editor')" [class]="mainViewMode() === 'video-editor' ? 'bg-' + currentTheme().primary + '-500 text-black shadow-lg' : 'hover:bg-white/10 text-gray-400'" class="px-3 py-1.5 rounded-full text-xs transition-all">VID</button>
            <button (click)="setMode('networking')" [class]="mainViewMode() === 'networking' ? 'bg-' + currentTheme().primary + '-500 text-black shadow-lg' : 'hover:bg-white/10 text-gray-400'" class="px-3 py-1.5 rounded-full text-xs transition-all">NET</button>
         </div>

        <button (click)="mainViewMode.set('profile')" class="p-2 w-8 h-8 rounded-full border border-white/10 bg-black/40 hover:bg-white/10 flex items-center justify-center transition-all" title="Profile">
            <i class="fa-solid fa-user text-xs"></i>
        </button>
        <button (click)="randomizeTheme()" class="p-2 w-8 h-8 rounded-full border border-white/10 bg-black/40 hover:bg-white/10 flex items-center justify-center transition-all" title="Random Theme">
            <i class="fa-solid fa-palette text-xs"></i>
        </button>
        <button (click)="toggleChatbot()" class="px-3 py-1.5 rounded-full border border-white/10 bg-gradient-to-r from-indigo-500/20 to-purple-500/20 hover:from-indigo-500/40 hover:to-purple-500/40 flex items-center gap-2 transition-all text-xs">
           <i class="fa-solid fa-sparkles text-purple-400"></i> AI CHAT
        </button>
      </div>
    </header>

    <!-- Main Content Area -->
    <div class="p-2 sm:p-6 bg-gradient-to-b from-transparent to-black/20 min-h-[500px]">
      <audio #mainAudioPlayer (timeupdate)="onTimeUpdate()" (loadedmetadata)="onLoadedMetadata()" (ended)="onTrackEnded()"></audio>
      <input type="file" #fileInput (change)="handleFiles($event)" multiple accept="audio/*" class="hidden">

      @switch (mainViewMode()) {
        @case ('dj') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- DECK A -->
            <div class="rounded-xl border border-white/10 bg-black/30 p-4 flex flex-col gap-4 shadow-inner relative overflow-hidden group">
              <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
              <h3 class="text-center font-bold tracking-widest text-blue-400">[ DECK A ]</h3>
              <div class="bg-black/50 p-2 text-center text-xs truncate rounded border border-white/5 font-mono text-blue-200">
                {{ deckA().track.name }}
              </div>
              <div class="w-full aspect-square rounded-full flex items-center justify-center relative shadow-2xl shadow-blue-900/20">
                 <div class="absolute inset-0 rounded-full border-4 border-slate-800"></div>
                 <img [src]="deckA().track.albumArtUrl" class="w-56 h-56 rounded-full object-cover animate-[spin_4s_linear_infinite]" [style.animation-play-state]="deckA().isPlaying ? 'running' : 'paused'">
              </div>
               <div class="flex justify-center gap-4">
                 <button class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-full font-bold shadow-lg shadow-blue-900/50 transition-all active:scale-95">
                    @if (deckA().isPlaying) { <i class="fa-solid fa-pause"></i> } @else { <i class="fa-solid fa-play"></i> }
                  </button>
                  <button class="px-6 py-2 border border-white/10 hover:bg-white/10 rounded-full transition-all">CUE</button>
               </div>
            </div>
            <!-- DECK B -->
             <div class="rounded-xl border border-white/10 bg-black/30 p-4 flex flex-col gap-4 shadow-inner relative overflow-hidden group">
              <div class="absolute inset-0 bg-gradient-to-br from-red-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
              <h3 class="text-center font-bold tracking-widest text-red-400">[ DECK B ]</h3>
              <div class="bg-black/50 p-2 text-center text-xs truncate rounded border border-white/5 font-mono text-red-200">
                {{ deckB().track.name }}
              </div>
              <div class="w-full aspect-square rounded-full flex items-center justify-center relative shadow-2xl shadow-red-900/20">
                 <div class="absolute inset-0 rounded-full border-4 border-slate-800"></div>
                 <img [src]="deckB().track.albumArtUrl" class="w-56 h-56 rounded-full object-cover animate-[spin_4s_linear_infinite]" [style.animation-play-state]="deckB().isPlaying ? 'running' : 'paused'">
              </div>
               <div class="flex justify-center gap-4">
                 <button class="px-6 py-2 bg-red-600 hover:bg-red-500 text-white rounded-full font-bold shadow-lg shadow-red-900/50 transition-all active:scale-95">
                    @if (deckB().isPlaying) { <i class="fa-solid fa-pause"></i> } @else { <i class="fa-solid fa-play"></i> }
                  </button>
                  <button class="px-6 py-2 border border-white/10 hover:bg-white/10 rounded-full transition-all">CUE</button>
               </div>
            </div>
          </div>
        }
        @case ('live') { <app-live-session [theme]="currentTheme()"></app-live-session> }
        @case ('piano-roll') { <app-piano-roll [theme]="currentTheme()"></app-piano-roll> }
        @case ('image-editor') { <app-image-editor [theme]="currentTheme()" [initialPrompt]="imageEditorInitialPrompt()" (imageSelected)="handleImageSelectedForAlbumArt($event)" (imageAnalysisRequest)="handleChatbotCommand({ action: 'ANALYZE_IMAGE', parameters: { imageUrl: $event }})" (imageGenerated)="handleImageGenerated($event)"></app-image-editor> }
        @case ('video-editor') { <app-video-editor [theme]="currentTheme()" [initialPrompt]="videoEditorInitialPrompt()" [imageForVideoGeneration]="lastImageEditorImageUrl()"></app-video-editor> }
        @case ('networking') { <app-networking [theme]="currentTheme()" [initialSearchQuery]="networkingLocationQuery()" (artistProfileSelected)="selectedArtistProfile.set($event)"></app-networking> }
        @case ('profile') { <app-profile-editor [theme]="currentTheme()"></app-profile-editor> }
        @default {
          <!-- Player Mode -->
          <div class="flex flex-col lg:flex-row items-start gap-6 h-full">
            <!-- Left Panel: Player and Visualizer -->
            <div class="w-full lg:w-2/3 flex flex-col items-center gap-6">
              <div class="w-full h-64 rounded-2xl overflow-hidden border border-white/10 shadow-lg bg-black/40">
                  <app-audio-visualizer [analyserNode]="getMasterAnalyser()" [theme]="currentTheme()" class="w-full h-full"></app-audio-visualizer>
              </div>
              
              <div class="text-center space-y-2">
                <h3 class="text-2xl font-bold tracking-tight text-white">{{ currentPlayerTrack()?.name || 'NO TRACK LOADED' }}</h3>
                <p class="text-sm text-gray-400">{{ currentPlayerTrack()?.artist || 'Select a file to begin' }}</p>
              </div>

              <div class="w-full max-w-2xl flex flex-col gap-4 bg-white/5 p-6 rounded-2xl border border-white/5 backdrop-blur-sm">
                <div class="flex items-center gap-4 text-xs font-mono text-gray-400">
                  <span>{{ formatTime(currentTime()) }}</span>
                  <input type="range" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-white" min="0" [max]="duration()" [value]="currentTime()" (input)="seek($event)">
                  <span>{{ formatTime(duration()) }}</span>
                </div>
                
                <div class="flex items-center justify-center gap-8">
                  <button class="text-gray-400 hover:text-white transition-colors" (click)="playPrevious()"><i class="fa-solid fa-backward-step fa-xl"></i></button>
                  <button class="w-16 h-16 rounded-full bg-white text-black hover:scale-105 active:scale-95 transition-all flex items-center justify-center shadow-lg shadow-white/20" (click)="togglePlay()">
                    @if (isPlaying()) { <i class="fa-solid fa-pause fa-xl"></i> } @else { <i class="fa-solid fa-play fa-xl pl-1"></i> }
                  </button>
                  <button class="text-gray-400 hover:text-white transition-colors" (click)="playNext()"><i class="fa-solid fa-forward-step fa-xl"></i></button>
                </div>
                
                <div class="flex items-center justify-center gap-4 w-full max-w-xs mx-auto">
                  <i class="fa-solid fa-volume-low text-gray-500 text-xs"></i>
                  <input type="range" min="0" max="1" step="0.01" [value]="volume()" (input)="onVolumeChange($event)" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-gray-400">
                  <i class="fa-solid fa-volume-high text-gray-500 text-xs"></i>
                </div>
              </div>
            </div>

            <!-- Right Panel: Playlist -->
            <div class="w-full lg:w-1/3 border border-white/10 rounded-2xl bg-black/20 backdrop-blur-md flex flex-col h-[500px]">
              <div class="p-4 border-b border-white/5">
                <button (click)="fileInput.click()" class="w-full py-3 rounded-xl bg-white/10 hover:bg-white/20 text-sm font-bold transition-all border border-white/5">
                    <i class="fa-solid fa-plus mr-2"></i> LOAD TRACKS
                </button>
              </div>
              <div class="flex-1 overflow-y-auto p-2 space-y-1">
                @for (track of playlist(); track track.url; let i = $index) {
                  <div class="p-3 rounded-lg cursor-pointer flex items-center justify-between group transition-all" 
                       [class]="i === currentTrackIndex() ? 'bg-' + currentTheme().primary + '-500/20 text-' + currentTheme().primary + '-200 border border-' + currentTheme().primary + '-500/30' : 'hover:bg-white/5 text-gray-400 border border-transparent'"
                       (click)="currentTrackIndex.set(i)">
                    <span class="truncate text-sm font-medium">{{ track.name }}</span>
                    @if (i === currentTrackIndex() && isPlaying()) { <i class="fa-solid fa-chart-simple animate-pulse text-xs"></i> }
                  </div>
                }
                 @if (playlist().length === 0) {
                    <div class="flex flex-col items-center justify-center h-full text-gray-600 space-y-2">
                        <i class="fa-solid fa-music text-2xl"></i>
                        <span class="text-xs">Playlist Empty</span>
                    </div>
                }
              </div>
            </div>
          </div>
        }
      }
    </div>
  </div>

  <!-- Chatbot -->
  @if (showChatbot()) {
    <app-chatbot [theme]="currentTheme()" [mainViewMode]="mainViewMode()" (close)="toggleChatbot()" (appCommand)="handleChatbotCommand($event)" [imageToAnalyzeUrl]="imageToAnalyzeUrl()" [videoToAnalyze]="videoToAnalyze" (imageAnalysisResult)="imageAnalysisResult.set($event)" (mapLocationResult)="mapLocationResult.set($event)"></app-chatbot>
  }
  
  <!-- Modals -->
  @if (showImageAnalysisModal() && imageAnalysisResult()) {
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40" (click)="showImageAnalysisModal.set(false)"></div>
    <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-6 bg-slate-900 border border-white/10 rounded-2xl z-50 shadow-2xl animate-fade-in text-gray-200">
      <h3 class="text-lg font-bold mb-4 text-purple-400"><i class="fa-solid fa-eye mr-2"></i>Vision Analysis</h3>
      <p class="whitespace-pre-wrap text-sm leading-relaxed max-h-64 overflow-y-auto pr-2">{{ imageAnalysisResult() }}</p>
      <button (click)="showImageAnalysisModal.set(false); imageAnalysisResult.set(null);" class="mt-6 py-2 w-full bg-white/10 hover:bg-white/20 rounded-lg transition-colors text-sm">CLOSE</button>
    </div>
  }
  @if (showMapResultsModal() && mapLocationResult()) {
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40" (click)="showMapResultsModal.set(false)"></div>
    <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-6 bg-slate-900 border border-white/10 rounded-2xl z-50 shadow-2xl animate-fade-in text-gray-200">
      <h3 class="text-lg font-bold mb-4 text-green-400"><i class="fa-solid fa-map-location-dot mr-2"></i>Map Intelligence</h3>
      <p class="whitespace-pre-wrap text-sm leading-relaxed">{{ mapLocationResult() }}</p>
      <button (click)="showMapResultsModal.set(false); mapLocationResult.set(null);" class="mt-6 py-2 w-full bg-white/10 hover:bg-white/20 rounded-lg transition-colors text-sm">CLOSE</button>
    </div>
  }
  @if (showArtistDetailModal() && selectedArtistProfile()) {
    @if (selectedArtistProfile(); as artist) {
      <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40" (click)="showArtistDetailModal.set(false)"></div>
      <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-6 bg-slate-900 border border-blue-500/30 rounded-2xl z-50 shadow-2xl animate-fade-in">
        <div class="flex gap-6 items-start">
          <img [src]="artist.imageUrl" class="w-24 h-24 rounded-full border-2 border-blue-500/50 object-cover shadow-lg">
          <div>
            <h3 class="text-xl font-bold text-blue-400">{{ artist.name }}</h3>
            <p class="text-sm text-gray-400 mt-1">{{ artist.genre }}</p>
            <p class="text-xs text-gray-500 flex items-center gap-1 mt-1"><i class="fa-solid fa-location-dot"></i> {{ artist.location }}</p>
          </div>
        </div>
        <div class="my-6 bg-black/30 p-4 rounded-xl border border-white/5 text-sm text-gray-300 leading-relaxed">
            {{ artist.bio }}
        </div>
        <button (click)="showArtistDetailModal.set(false); selectedArtistProfile.set(null);" class="py-3 w-full bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors font-bold shadow-lg shadow-blue-900/30">CLOSE PROFILE</button>
      </div>
    }
  }
  @if (showApplyAlbumArtModal() && imageToApplyAsAlbumArt()) {
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40" (click)="showApplyAlbumArtModal.set(false)"></div>
    <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-6 bg-slate-900 border border-white/10 rounded-2xl z-50 shadow-2xl animate-fade-in">
      <h3 class="text-lg font-bold mb-4 text-center text-white">Apply Artwork</h3>
      <img [src]="imageToApplyAsAlbumArt()" class="w-full aspect-square object-cover rounded-lg shadow-lg mb-6 border border-white/10">
      <div class="grid grid-cols-1 gap-3">
        <button (click)="applyImageAsAlbumArt('player')" class="py-3 rounded-lg bg-white/5 hover:bg-white/10 border border-white/5 transition-colors text-sm">SET AS MAIN PLAYER</button>
        <div class="grid grid-cols-2 gap-3">
            <button (click)="applyImageAsAlbumArt('A')" class="py-3 rounded-lg bg-blue-500/20 hover:bg-blue-500/30 text-blue-200 border border-blue-500/20 transition-colors text-sm">DECK A</button>
            <button (click)="applyImageAsAlbumArt('B')" class="py-3 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-200 border border-red-500/20 transition-colors text-sm">DECK B</button>
        </div>
      </div>
      <button (click)="showApplyAlbumArtModal.set(false);" class="mt-4 w-full text-xs text-gray-500 hover:text-white transition-colors">CANCEL</button>
    </div>
  }
  @if (showEqPanel()) {
    <app-eq-panel [eqSettings]="eqSettings()" [enhancements]="enhancements()" [theme]="currentTheme()" (close)="toggleEqPanel()" (eqChange)="onMasterEqChange($event)" (enhancementsChange)="enhancements.set($event)"></app-eq-panel>
  }
</main>